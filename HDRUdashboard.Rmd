---
title: "HDRU dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE,echo=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(plotly)
```
Page 1 - Figures {data-icon="fa-list"}
=======================================================
```{r dataImport}
admissionData <- read_csv("data/hdru_admission_raw.csv")
  # not all PIDs are unique, e.g. KAA7V0 - can people be admitted, then discharged, then re-admitted from HDRU?
  # which variable captures date of discharge?
dailyData <- read_csv("data/hdru_daily_raw.csv")
# merge data; needed to calculate duration of organ support; use individual files for tables figures that only focus on admission or daily data
datAdmTmp<-admissionData 
datDailyTmp<-dailyData
colnames(datAdmTmp)<-paste(sep="_","adm",colnames(datAdmTmp)) 
colnames(datDailyTmp)<-paste(sep="_","dly",colnames(datDailyTmp))
datMerged<-full_join(datAdmTmp,datDailyTmp,by=c("adm_pid" = "dly_pid"))
osaDur<-dailyData %>%
  select(pid,osa1,osa2) %>%
  group_by(pid) %>%
  summarise(osa1Dur=sum(osa1[!is.na(osa1)]),osa2Dur=sum(osa2[!is.na(osa1)])) # counts days where organ support was recorded
admissionData<-left_join(admissionData,osaDur,by="pid")
# table(admissionData$adm1,admissionData$osa1Dur) # conflicts: 10 with adm1==1, but osa1Dur==0, 1 with adm1==0 but osa1Dur>0
# table(admissionData$adm2,admissionData$osa2Dur) # conflicts: 4 with adm2==1, but osa2Dur==0, 1 with adm2==0 but osa2Dur>0
```

```{r weekSelect}
curWeek<-dmy("27/04/2020","04/05/2020","11/05/2020","18/05/2020","25/05/2020")
  # weeks to start on Mondays
  # this variable to become a shiny input / selection field
```

Row {data-width=350}
-----------------------------------------------------------------------

### Weekly admissions, available outcome data, organ support

```{r}
datOutcome<-dailyData %>%
  mutate(pid=pid,outcome=ifelse(!is.na(outcome) & outcome!=1,1,0)) %>%
  group_by(pid) %>%
  summarise(outcomeKnown=max(outcome))
admissionsWeekly<-admissionData %>%
  left_join(y=datOutcome,by="pid") %>%
  mutate(outcomeKnown=ifelse(is.na(outcomeKnown),0,1)) %>%
  group_by(week=cut(dmy(data_date),"week",start.on.monday=TRUE)) %>%
  summarise(n=sum(!is.na(pid)),nOutcomeKnown=sum(outcomeKnown==1),nOrganSupportOxygen=sum(adm1==1),nOrganSupportFluidBalance=sum(adm2=1)) %>%
  pivot_longer(cols=-week,names_to="countType",values_to="n")
  # outcome data needs to be taken from the daily data
admissionsWeekly$countType<-factor(admissionsWeekly$countType,levels=c("n","nOutcomeKnown","nOrganSupportOxygen","nOrganSupportFluidBalance"))
admissionsWeekly %>%
  filter(is.element(el=ymd(week),set=ymd(curWeek))) %>%
  ggplot(mapping=aes(x=week,y=n,fill=countType)) +
  geom_bar(position="dodge",stat="identity") +
  scale_fill_manual(values=c("steelblue","grey","salmon","orange"),name="",labels=c("admitted","outcome recorded","required oxygen support","required fluid balance")) +
  ylab("frequency") +
  theme(legend.position="top",text=element_text(size=14))
```

### Age and sex distribution

```{r}
admissionData$agegrp <- NA
admissionData$agegrp[admissionData$age <= 30] <- "0-30"
admissionData$agegrp[admissionData$age > 30 & admissionData$age <= 39.9] <- "30-39"
admissionData$agegrp[admissionData$age > 40 & admissionData$age <= 49.9] <- "40-49"
admissionData$agegrp[admissionData$age > 50 & admissionData$age <= 59.9] <- "50-59"
admissionData$agegrp[admissionData$age > 60] <- "60+"

admissionDataSex <- admissionData %>%
  group_by(sex,agegrp) %>%
  summarize(nadmn = sum(!is.na(pid)))
ggplot(admissionDataSex,aes(agegrp,nadmn,fill=factor(sex))) +
  geom_bar(stat = "identity",position = position_dodge2(preserve="single"))+ 
  theme_minimal() +
  xlab("Age at admission") +
  ylab("Frequency") +
  theme(axis.title.x = element_text(size = 18),
        axis.title.y = element_text(size = 18),
        axis.text = element_text(size = 16),
        legend.title = element_blank(),
        legend.text = element_text(size = 18),
        legend.position = "top")+
  scale_fill_manual(values = c("#d7bde2","#a9cce3"),labels=c("Female","Male"))

```

Row {data-width=350}
-----------------------------------------------------------------------

### Organ support duration

```{r}
admissionData %>%
  select(pid,osa1Dur,osa2Dur) %>%
  pivot_longer(cols=-pid,names_to="osType",values_to="duration") %>%
  mutate(osType=factor(ifelse(osType=="osa1Dur","Oxygen administration.","Careful fluid balance."),levels=c("Oxygen administration.","Careful fluid balance."))) %>%
  
  ggplot(mapping=aes(x=osType,y=duration,fill=osType)) +
  geom_boxplot() +
  scale_fill_manual(values=c("salmon","orange")) +
  theme(legend.position="none",text=element_text(size=14)) +
  xlab("organ support") +
  ylab("duration")
```

### Some table

```{r}
```

Page 2 - Tables {data-icon="fa-list"}
======================================================================
